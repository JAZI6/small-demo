<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>图片懒加载</title>
        <style>
            ul,li {
                list-style: none;
            }

            .container {
                width: 600px;
                margin: 0 auto;
            }

            .container li {
                float: left;
                margin: 10px 10px;
            }

            .container li img {
                width: 260px;
                height: 200px;
            }

            .clearfix:after {
                content: "";
                display: block;
                clear: both;
            }
        </style>
    </head>
    <body>
        <ul class="container clearfix">
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/1.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/2.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/3.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/4.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/5.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/6.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/7.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/8.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/9.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/10.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/11.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/12.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/13.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/14.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/15.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/16.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/1.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/2.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/3.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/4.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/5.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/6.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/7.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/sd.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/9.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/10.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/11.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/12.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/13.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/14.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/15.jpg"/>
                </a>
            </li>
            <li>
                <a href="#">
                    <img src="lazy_load_img/loading.svg" data-src="lazy_load_img/16.jpg"/>
                </a>
            </li>
        </ul>
        <script src="./jquery/jquery-3.1.1.min.js" type="text/javascript"></script>
        <script type="text/javascript">
            class ImgLazyLoad {
                constructor(aTarget) {
                    this.aImg = aTarget;
                    this.nWinScrTop = $(window).scrollTop();
                    this.nWinHeight = $(window).height();
                    this.timer1 = null;
                    this.timer2 = null;
                    //这里踩了一个坑，jquery的scrollTop是返回数值，这个数值不是动态变化的，仅仅指当时的，目前只有dom的nodeList是动态变化的！！！
                    this.init();
                }

                init() {
                    let _this = this,
                        $win = $(window);
                    $(this.aImg).not('.loaded').each(function() {
                            _this.isVisible($(this)) && _this.show($(this));
                    });
                    $win.on('resize', () => {
                        this.debounce(() => {
                            this.nWinHeight = $win.height();
                        });
                    });
                    $win.on('scroll', () => {
                        this.debounce(() => {
                            _this.nWinScrTop = $win.scrollTop();
                            $(this.aImg).not('.loaded').each(function() {
                                _this.isVisible($(this)) && _this.show($(this));
                            });
                        });
                    });
                }

                isVisible($target) {
                    if((this.nWinScrTop + this.nWinHeight > $target.offset().top) &&
                        (this.nWinScrTop < $target.offset().top + $target.outerHeight(true)))
                    {
                        return true;
                    }
                    else
                    {
                        return false;
                    }
                }

                show($target) {
                    $target.on('error', () => {
                        $target.attr('src', 'lazy_load_img/loadFail.png');
                    });
                    $target.attr('src', $target.attr('data-src'));
                    $target.addClass('loaded');
                }

                debounce(func) {
                    clearTimeout(this.timer1);
                    this.timer1 = setTimeout(() => {
                        func();
                    }, 500);
                }

                throttle(func) {
                    if(!this.timer2)
                    {
                        this.timer2 = setTimeout(() => {
                            func();
                            this.timer2 = null;
                        }, 1000);
                    }
                }
            }

            $(document).ready(function() {
                let aImg = document.getElementsByTagName('img');
                console.log(aImg.length);
                new ImgLazyLoad(aImg);
            });
        </script>
    </body>
</html>
